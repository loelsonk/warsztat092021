!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports):"function"==typeof define&&define.amd?define(["exports"],o):o((e="undefined"!=typeof globalThis?globalThis:e||self).graphqlWs={})}(this,(function(e){"use strict";const o=Object.prototype.hasOwnProperty;function n(e){return"object"==typeof e&&null!==e}function t(e,n){return o.call(e,n)}function r(e,t){return o.call(e,t)&&n(e[t])}function a(e,n){return o.call(e,n)&&"string"==typeof e[n]}const i="graphql-transport-ws";var s,l;function c(o){if(n(o)){if(!a(o,"type"))return!1;switch(o.type){case e.MessageType.ConnectionInit:return!t(o,"payload")||void 0===o.payload||n(o.payload);case e.MessageType.ConnectionAck:case e.MessageType.Ping:case e.MessageType.Pong:return!t(o,"payload")||void 0===o.payload||n(o.payload);case e.MessageType.Subscribe:return a(o,"id")&&r(o,"payload")&&(!t(o.payload,"operationName")||void 0===o.payload.operationName||null===o.payload.operationName||"string"==typeof o.payload.operationName)&&a(o.payload,"query")&&(!t(o.payload,"variables")||void 0===o.payload.variables||null===o.payload.variables||r(o.payload,"variables"))&&(!t(o.payload,"extensions")||void 0===o.payload.extensions||null===o.payload.extensions||r(o.payload,"extensions"));case e.MessageType.Next:return a(o,"id")&&r(o,"payload");case e.MessageType.Error:return a(o,"id")&&(i=o.payload,Array.isArray(i)&&i.length>0&&i.every((e=>"message"in e)));case e.MessageType.Complete:return a(o,"id");default:return!1}}var i;return!1}function d(e,o){if(c(e))return e;if("string"!=typeof e)throw new Error("Message not parsable");const n=JSON.parse(e,o);if(!c(n))throw new Error("Invalid message");return n}function p(e,o){if(!c(e))throw new Error("Cannot stringify invalid message");return JSON.stringify(e,o)}function y(e){return n(e)&&"code"in e&&"reason"in e}e.CloseCode=void 0,(s=e.CloseCode||(e.CloseCode={}))[s.InternalServerError=4500]="InternalServerError",s[s.BadRequest=4400]="BadRequest",s[s.Unauthorized=4401]="Unauthorized",s[s.Forbidden=4403]="Forbidden",s[s.SubprotocolNotAcceptable=4406]="SubprotocolNotAcceptable",s[s.ConnectionInitialisationTimeout=4408]="ConnectionInitialisationTimeout",s[s.SubscriberAlreadyExists=4409]="SubscriberAlreadyExists",s[s.TooManyInitialisationRequests=4429]="TooManyInitialisationRequests",e.MessageType=void 0,(l=e.MessageType||(e.MessageType={})).ConnectionInit="connection_init",l.ConnectionAck="connection_ack",l.Ping="ping",l.Pong="pong",l.Subscribe="subscribe",l.Next="next",l.Error="error",l.Complete="complete",e.GRAPHQL_TRANSPORT_WS_PROTOCOL=i,e.createClient=function(o){const{url:n,connectionParams:t,lazy:r=!0,onNonLazyError:a=console.error,lazyCloseTimeout:s=0,keepAlive:l=0,disablePong:c,retryAttempts:u=5,retryWait:g=async function(e){let o=1e3;for(let n=0;n<e;n++)o*=2;await new Promise((e=>setTimeout(e,o+Math.floor(2700*Math.random()+300))))},isFatalConnectionProblem:f=(e=>!y(e)),on:m,webSocketImpl:b,generateID:x=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const o=16*Math.random()|0;return("x"==e?o:3&o|8).toString(16)}))},jsonMessageReplacer:v,jsonMessageReviver:C}=o;let w;if(b){if(!("function"==typeof(M=b)&&"constructor"in M&&"CLOSED"in M&&"CLOSING"in M&&"CONNECTING"in M&&"OPEN"in M))throw new Error("Invalid WebSocket implementation provided");w=b}else"undefined"!=typeof WebSocket?w=WebSocket:"undefined"!=typeof global?w=global.WebSocket||global.MozWebSocket:"undefined"!=typeof window&&(w=window.WebSocket||window.MozWebSocket);var M;if(!w)throw new Error("WebSocket implementation missing");const T=w,S=(()=>{const e=(()=>{const e={};return{on:(o,n)=>(e[o]=n,()=>{delete e[o]}),emit(o){var n;"id"in o&&(null===(n=e[o.id])||void 0===n||n.call(e,o))}}})(),o={connecting:(null==m?void 0:m.connecting)?[m.connecting]:[],opened:(null==m?void 0:m.opened)?[m.opened]:[],connected:(null==m?void 0:m.connected)?[m.connected]:[],ping:(null==m?void 0:m.ping)?[m.ping]:[],pong:(null==m?void 0:m.pong)?[m.pong]:[],message:(null==m?void 0:m.message)?[e.emit,m.message]:[e.emit],closed:(null==m?void 0:m.closed)?[m.closed]:[],error:(null==m?void 0:m.error)?[m.error]:[]};return{onMessage:e.on,on(e,n){const t=o[e];return t.push(n),()=>{t.splice(t.indexOf(n),1)}},emit(e,...n){for(const t of o[e])t(...n)}}})();let h,E=0,N=!1,P=0,I=!1;async function O(){const[o,r]=await(null!=h?h:h=new Promise(((o,r)=>(async()=>{if(N){if(await g(P),!E)return h=void 0,r({code:1e3,reason:"All Subscriptions Gone"});P++}S.emit("connecting");const a=new T("function"==typeof n?await n():n,i);let s;function y(){isFinite(l)&&l>0&&(clearTimeout(s),s=setTimeout((()=>{a.readyState===T.OPEN&&(a.send(p({type:e.MessageType.Ping})),S.emit("ping",!1,void 0))}),l))}a.onerror=e=>{S.emit("error",e)},a.onclose=e=>{h=void 0,clearTimeout(s),S.emit("closed",e),r(e)},a.onopen=async()=>{try{S.emit("opened",a);const o="function"==typeof t?await t():t;a.send(p(o?{type:e.MessageType.ConnectionInit,payload:o}:{type:e.MessageType.ConnectionInit},v)),y()}catch(o){a.close(e.CloseCode.BadRequest,o instanceof Error?o.message:new Error(o).message)}};let u=!1;a.onmessage=({data:n})=>{try{const t=d(n,C);if(S.emit("message",t),"ping"===t.type||"pong"===t.type)return S.emit(t.type,!0,t.payload),void("pong"===t.type?y():c||(a.send(p(t.payload?{type:e.MessageType.Pong,payload:t.payload}:{type:e.MessageType.Pong})),S.emit("pong",!1,t.payload)));if(u)return;if(t.type!==e.MessageType.ConnectionAck)throw new Error(`First message cannot be of type ${t.type}`);u=!0,S.emit("connected",a,t.payload),N=!1,P=0,o([a,new Promise(((e,o)=>a.addEventListener("close",o)))])}catch(o){a.close(e.CloseCode.BadRequest,o instanceof Error?o.message:new Error(o).message)}}})())));o.readyState===T.CLOSING&&await r;let a=()=>{};const y=new Promise((e=>a=e));return[o,a,Promise.race([y.then((()=>{if(!E){const e=()=>o.close(1e3,"Normal Closure");isFinite(s)&&s>0?setTimeout((()=>{E||o.readyState!==T.OPEN||e()}),s):e()}})),r])]}function A(o){if(y(o)&&(n=o.code,![1e3,1001,1006,1005,1012,1013,1013].includes(n)&&n>=1e3&&n<=1999||[e.CloseCode.InternalServerError,e.CloseCode.BadRequest,e.CloseCode.Unauthorized,e.CloseCode.SubprotocolNotAcceptable,e.CloseCode.SubscriberAlreadyExists,e.CloseCode.TooManyInitialisationRequests].includes(o.code)))throw o;var n;if(I)return!1;if(y(o)&&1e3===o.code)return E>0;if(!u||P>=u)throw o;if(f(o))throw o;return N=!0}return r||(async()=>{for(E++;;)try{const[,,e]=await O();await e}catch(e){try{if(!A(e))return}catch(e){return null==a?void 0:a(e)}}})(),{on:S.on,subscribe(o,n){const t=x();let r=!1,a=!1,i=()=>{E--,r=!0};return(async()=>{for(E++;;)try{const[s,l,c]=await O();if(r)return l();const d=S.onMessage(t,(o=>{switch(o.type){case e.MessageType.Next:return void n.next(o.payload);case e.MessageType.Error:return a=!0,r=!0,n.error(o.payload),void i();case e.MessageType.Complete:return r=!0,void i()}}));return s.send(p({id:t,type:e.MessageType.Subscribe,payload:o},v)),i=()=>{r||s.readyState!==T.OPEN||s.send(p({id:t,type:e.MessageType.Complete},v)),E--,r=!0,l()},void await c.finally(d)}catch(e){if(!A(e))return}})().catch(n.error).then((()=>{a||n.complete()})),()=>{r||i()}},async dispose(){if(I=!0,h){const[e]=await h;e.close(1e3,"Normal Closure")}}}},e.isMessage=c,e.parseMessage=d,e.stringifyMessage=p,Object.defineProperty(e,"__esModule",{value:!0})}));
